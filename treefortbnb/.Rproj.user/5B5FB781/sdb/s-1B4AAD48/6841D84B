{
    "contents" : "library(dplyr)\nlibrary(tidyr)\n\n\n\n## Cleaning\nsource(\"str_helpers.R\")\n\n\n# Start Analysis\nd0 <- read.csv(\"Data+for+TreefortBnB+Puzzle.csv\", stringsAsFactors = FALSE)\nnames(d0) <- c(\"id\",\"city\",\"state\",\"price\",\"nreviews\")\nd0$originalCities <- paste(d0$city, d0$state, sep = \" - \")\n\n# check if clean\nsort((unique(d0$city)))\nsort((unique(d0$state)))\nlength((unique(d0$state)))\n\n\n# cities and states\n# City original from: http://simplemaps.com/resources/us-cities-data (cities.csv)\n# with some manual tweaking\ncityNames <- read.csv(\"us-cities.csv\")\ndict <- cityNames[c('name','alternativeNames')]\n\noriginalCities <- d0$originalCities\noriginalCities <- unique(originalCities)\n# Let's make an approximate replace\n\ncleanCities <- dictionaryMatch(originalCities,dict, maxDistance = 2)\ncities <- data.frame(originalCities = originalCities, cleanCities = cleanCities)\n\n# “Which Are the Most Expensive Cities in America to Book a Tree Fort?”\n\nd <- merge(d0, cities, by = \"originalCities\")\nnames(d)\nd <- d[c(\"id\",\"cleanCities\",\"price\",\"nreviews\",\"state\")]\nnames(d)[2] <- \"city\"\n\n\n## Analysis\n\n# median price of a tree fort in each of the top 100 cities that have the most units on the market.\n#Just send us back a table with a list of the median price in each city, ranked from most to least expensive. Restrict your analysis to just to the \"top 100\" cities that have the most units on the market.\n\nt <- d %>%\n  group_by(city) %>%\n  #filter(!is.na(city)) %>%\n  summarise(medianPrice = median(price), units = n()) %>%\n  top_n(100) %>%\n  arrange(medianPrice) %>%\n  select(city,medianPrice)\n\nwrite.csv(t,\"output.csv\",row.names = FALSE)\n\n\n\n# Get additional data\n\nsource(\"scrape_helpers.R\")\nurl <- \"https://en.wikipedia.org/wiki/List_of_United_States_cities_by_population\"\npopulation <- getWikipediaTable(url)\npopulation <- population[c(\"City\",\"State[5]\",\"2014 estimate\")]\nnames(population) <- c(\"city\",\"state\",\"population\")\npopulation$city <- removeNotes(population$city)\npopulation$state <- removeNotes(population$state)\npopulation$population <- as.numeric(gsub(\"[^[:digit:]]\",\"\",population$population))\n\nurl <- \"https://en.wikipedia.org/wiki/List_of_states_and_territories_of_the_United_States\"\nstates <- getWikipediaTable(url,1)\nstates <- states[c(\"State\",\"Abbr.\")]\nnames(states) <- c(\"state\",\"abbr\")\nwrite.csv(states,\"states.csv\",row.names = FALSE)\nstates$state <- trim_spaces(states$state) %>% removeNotes()\npopulation <- merge(population,states, by = \"state\",all.x = TRUE)\npopulation$city <- paste(population$city, population$abbr, sep=\" - \")\n\nd2 <- merge(d,population[c(\"population\",\"city\")])\n\n\n# Cities with the most units percapita (top 10)\n\nt2 <- d2 %>%\n  select(city,population) %>%\n  group_by(city,population) %>%\n  summarise(units = n()) %>%\n  mutate(unitsPerCapita = units/population) %>%\n  ungroup() %>%\n  arrange(desc(unitsPerCapita)) %>%\n  top_n(10)\n\n#\n\nt3 <- d %>%\n  select(state,price) %>%\n  group_by(state) %>%\n  summarise(units = n(), meanPrice = mean(price))\n\nwrite.csv(t3,\"treeforbnb-states.csv\",row.names = FALSE)\n\nlibrary(dmaps)\n# Experimental package: htmlwidgets wrapper for datamaps in R\n# devtools::install_github(\"jpmarindiaz/dmaps\")\n\n\n## Sort of hacky bivariate Choropleth\nd <- read.csv(\"treeforbnb-states.csv\")\nvar1 <- cut2(d[,2],g=3)\nlevels(var1) <- c(\"x1\",\"x2\",\"x3\")\nvar2 <- cut2(d[,3],g=3)\nlevels(var2) <- c(\"y1\",\"y2\",\"y3\")\n\nd$group <- paste(var1,var2,sep=\"\")\n\ngroups2d <- apply(expand.grid(paste0(\"x\",1:3),paste0(\"y\",1:3)),1,\n                  function(r)paste0(r[1],r[2]))\ncolors2d <- c(\"#e8e8e8\",\"#e4acac\",\"#c85a5a\",\"#b0d5df\",\"#ad93a5\",\"#985356\",\"#64acbe\",\"#62718c\",\"#574249\")\ncustomPalette <- data.frame(group = groups2d, color = colors2d)\n\nopts <- list(\n  defaultFill = \"#FFFFFF\",\n  borderColor = \"#CCCCCC\",\n  borderWidth = 0.3,\n  highlightFillColor = \"#999999\",\n  highlightBorderWidth = 1,\n  palette = \"PuBu\",\n  customPalette = customPalette,\n  choroLegend = list(show = FALSE),\n  bivariateLegend = list(show = TRUE, var1Label = \"Units\", var2Label = \"Median Price\")\n)\n\ndmaps(\"us_states\", data = d,\n             groupCol = \"group\",\n             regionCols = \"state\",\n             opts = opts)\n\nmap <- dmaps(\"us_states\", data = d,\n      groupCol = \"group\",\n      regionCols = \"state\",\n      opts = opts)\nsaveWidget(map,\"map.html\")\n\n\n\n\n",
    "created" : 1462380636660.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "1788699481",
    "id" : "6841D84B",
    "lastKnownWriteTime" : 1462418351,
    "path" : "~/jprepo/playground/treefortbnb/00.R",
    "project_path" : "00.R",
    "properties" : {
    },
    "relative_order" : 1,
    "source_on_save" : false,
    "type" : "r_source"
}